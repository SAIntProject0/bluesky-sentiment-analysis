<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ReviewSky Sentiment Dashboard</title>
  <!-- explicit Chart.js version -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3E%F0%9F%8E%AD%3C/text%3E%3C/svg%3E">
  <meta name="description" content="Dashboard showing realtime sentiment and category view for ReviewSky data" />
  <style>
    :root{
      --bg:#fafafa; --text:#0f172a; --card:#fff; --border:#e6edf3;
      --positive:#10b981; --neutral:#64748b; --negative:#ef4444;
      --movie:#8b5cf6; --book:#ec4899; --music:#f97316; --game:#0ea5e9; --other:#64748b;
      --shadow:0 10px 25px -5px rgba(0,0,0,0.08); --transition:all .25s ease;
    }
    [data-theme="dark"]{
      --bg:#071025; --text:#e6eef7; --card:#0f1724; --border:#153044; --shadow:0 10px 25px -5px rgba(0,0,0,0.5);
    }
    *{box-sizing:border-box}
    body{font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; background:var(--bg); color:var(--text); margin:0; padding:28px; transition:var(--transition);}
    .container{max-width:1200px;margin:0 auto}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-bottom:28px}
    h1{font-size:1.9rem;margin:0;font-weight:800;letter-spacing:-0.02em;background:linear-gradient(90deg,var(--movie),var(--book),var(--music),var(--game));-webkit-background-clip:text;background-clip:text;color:transparent}
    .controls{display:flex;gap:10px;align-items:center}
    button,select{background:var(--card);border:1px solid var(--border);padding:8px 12px;border-radius:10px;cursor:pointer;box-shadow:var(--shadow);transition:var(--transition);color:var(--text)}
    button:active{transform:translateY(1px)}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:18px;margin-bottom:26px}
    .stat-card{background:var(--card);border-radius:14px;padding:18px;text-align:center;border:1px solid var(--border);box-shadow:var(--shadow)}
    .stat-label{font-size:.95rem;opacity:.8}
    .stat-value{font-size:2.2rem;font-weight:800;margin-top:6px}
    .charts{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:20px;margin-bottom:28px}
    .chart-card{background:var(--card);padding:18px;border-radius:14px;border:1px solid var(--border);box-shadow:var(--shadow)}
    .chart-card h3{margin:0 0 12px 0;font-size:1.1rem}
    .posts-section h2{font-size:1.25rem;margin:6px 0 12px}
    .posts-grid{display:grid;gap:14px}
    .post-card{background:var(--card);padding:14px;border-radius:12px;border:1px solid var(--border);box-shadow:var(--shadow);display:flex;flex-direction:column;gap:10px}
    .post-header{display:flex;justify-content:space-between;align-items:center;font-weight:700}
    .post-meta{display:flex;gap:8px;align-items:center}
    .category-badge{padding:6px 10px;border-radius:999px;color:white;font-weight:700;font-size:.8rem}
    .cat-movie{background:var(--movie)} .cat-book{background:var(--book)} .cat-music{background:var(--music)} .cat-game{background:var(--game)} .cat-other{background:var(--other)}
    .sent-pos{color:var(--positive)} .sent-neut{color:var(--neutral)} .sent-neg{color:var(--negative)}
    .post-text{font-size:1rem;line-height:1.5}
    .last-update{margin-top:18px;padding-top:12px;border-top:1px solid var(--border);opacity:.85;font-style:italic}
    .loading{text-align:center;padding:40px;color:var(--neutral)}
    .error{background:#fee;padding:12px;border-radius:10px;color:#900}
    .chart-card canvas {
      display: block;        /* prevents inline baseline spacing oddness */
      width: 100% !important;/* fill available width */
      height: 220px !important; /* fixed visual height so Chart.js won't expand parent */
      max-height: 380px;     /* safety cap for very tall screens */
      object-fit: contain;   /* safe fallback */
    }
    #trendCard canvas { height: 260px !important; }
    @media (max-width:480px){h1{font-size:1.3rem}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ReviewSky Sentiment Dashboard</h1>
      <div class="controls" role="toolbar" aria-label="dashboard controls">
        <select id="vizSelect" title="Choose visualization">
          <option value="default">Default (Category + Sentiment)</option>
          <option value="stacked">Category √ó Sentiment (Stacked)</option>
          <option value="trend">Sentiment Trend (time series)</option>
        </select>
        <button id="refreshBtn" title="Refresh data now">üîÅ Refresh</button>
        <button id="exportBtn" title="Download posts as CSV">‚¨áÔ∏è Export CSV</button>
        <button id="themeToggle" aria-pressed="false">üåì Theme</button>
      </div>
    </header>

    <section class="stats-grid" aria-live="polite">
      <div class="stat-card" aria-label="positive count">
        <div class="stat-label">Positive</div>
        <div class="stat-value" id="positiveCount">0</div>
      </div>
      <div class="stat-card" aria-label="neutral count">
        <div class="stat-label">Neutral</div>
        <div class="stat-value" id="neutralCount">0</div>
      </div>
      <div class="stat-card" aria-label="negative count">
        <div class="stat-label">Negative</div>
        <div class="stat-value" id="negativeCount">0</div>
      </div>
    </section>

    <section class="charts" id="chartsArea">
      <div class="chart-card">
        <h3 id="chartTitle">Reviews by Category</h3>
        <canvas id="categoryChart" aria-label="Category chart" height="220"></canvas>
      </div>

      <div class="chart-card">
        <h3>Sentiment Distribution</h3>
        <canvas id="sentimentChart" aria-label="Sentiment donut" height="220"></canvas>
      </div>

      <div class="chart-card" id="trendCard" style="display:none">
        <h3>Sentiment over Time</h3>
        <canvas id="trendChart" aria-label="Sentiment trend" height="220"></canvas>
      </div>
    </section>

    <section class="posts-section">
      <h2>Latest Reviews from #ReviewSky</h2>
      <div class="posts-grid" id="postsContainer">
        <div class="loading">Loading real-time sentiment data...</div>
      </div>
    </section>

    <div class="last-update" id="lastUpdate">Auto-refreshes every 30 seconds ‚Ä¢ Updated every 2 hours via UNIX cron</div>
  </div>

  <script>
    // --- Config & globals ---
    const DATA_PATH = 'data/sentiment.json'; // change if needed
    let categoryChart = null, sentimentChart = null, trendChart = null;

    // Theme initialization
    const themeToggle = document.getElementById('themeToggle');
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
    themeToggle.textContent = savedTheme === 'light' ? 'üåô Dark' : '‚òÄÔ∏è Light';
    themeToggle.setAttribute('aria-pressed', savedTheme === 'dark');

    themeToggle.addEventListener('click', () => {
      const next = document.documentElement.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
      document.documentElement.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
      themeToggle.textContent = next === 'light' ? 'üåô Dark' : '‚òÄÔ∏è Light';
      themeToggle.setAttribute('aria-pressed', next === 'dark');
    });

    // Helpers
    const by = (arr, fn) => arr.reduce((acc, x) => { const k = fn(x); acc[k] = (acc[k] || 0) + 1; return acc; }, {});
    const safeGetEl = (id) => document.getElementById(id);
    const formatTime = (iso) => new Date(iso).toLocaleString();

    // --- Rendering posts safely (avoid innerHTML injection) ---
    function renderPosts(posts){
      const container = safeGetEl('postsContainer');
      if(!container) return;
      container.innerHTML = '';
      if(!posts || posts.length === 0){
        container.innerHTML = '<div class="loading">No reviews available yet.</div>';
        return;
      }

      posts.forEach(post => {
        const card = document.createElement('article');
        card.className = 'post-card';

        const header = document.createElement('div'); header.className = 'post-header';
        const handle = document.createElement('div'); handle.textContent = `@${post.handle || 'unknown'}`;
        const sentiment = document.createElement('div');
        sentiment.className = 'sentiment ' + (post.label === 'Positive' ? 'sent-pos' : post.label === 'Negative' ? 'sent-neg' : 'sent-neut');
        sentiment.textContent = post.label ? `${post.label} (${Math.round((post.score||0)*100)}%)` : 'Unknown';
        header.append(handle, sentiment);

        const meta = document.createElement('div'); meta.className = 'post-meta';
        const badge = document.createElement('span');
        const cat = post.category || 'Other';
        badge.className = 'category-badge ' + (cat === 'Movie/TV' ? 'cat-movie' : cat === 'Book' ? 'cat-book' : cat === 'Music' ? 'cat-music' : cat === 'Game' ? 'cat-game' : 'cat-other');
        badge.textContent = cat;
        meta.append(badge);

        const text = document.createElement('div'); text.className = 'post-text';
        // preserve newlines safely
        (post.text || '').split('\n').forEach((line,i) => { if(i) text.appendChild(document.createElement('br')); text.appendChild(document.createTextNode(line)); });

        card.append(header, meta, text);
        container.appendChild(card);
      });
    }

    // --- CSV Export ---
    function exportCSV(posts){
      if(!posts || posts.length === 0) return alert('No posts to export');
      const keys = ['handle','category','label','score','text','timestamp'];
      const rows = [keys.join(',')];
      posts.forEach(p => {
        const row = keys.map(k => {
          const v = p[k] == null ? '' : String(p[k]).replace(/"/g,'""');
          return `"${v}"`;
        }).join(',');
        rows.push(row);
      });
      const blob = new Blob([rows.join('\n')],{type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'reviews.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    // --- Chart rendering logic ---
    function destroyIf(chart){ if(chart && typeof chart.destroy === 'function') chart.destroy(); }

    function renderCharts(data, mode = 'default'){
      // guard elements
      const catEl = safeGetEl('categoryChart');
      const sentEl = safeGetEl('sentimentChart');
      const trendEl = safeGetEl('trendChart');
      if(!catEl || !sentEl) return;

      // Prepare data
      const posts = data.posts || [];
      // category counts from categories key if present, else from posts
      const categoriesFromData = data.categories || null;
      const categories = categoriesFromData ? Object.keys(categoriesFromData) : Array.from(new Set(posts.map(p => p.category || 'Other')));
      const categoryCounts = categories.map(c => categoriesFromData ? (categoriesFromData[c] || 0) : posts.filter(p => (p.category||'Other') === c).length);

      const sentiment = data.sentiment || posts.reduce((acc,p) => { acc[p.label] = (acc[p.label]||0) + 1; return acc; }, {});
      const sentCounts = [sentiment.Positive || 0, sentiment.Neutral || 0, sentiment.Negative || 0];

      // trend data: expects data.history = [{ts: ISO, Positive,Neutral,Negative}, ...]
      const history = Array.isArray(data.history) && data.history.length ? data.history : null;

      // destroy old charts
      destroyIf(categoryChart); destroyIf(sentimentChart); destroyIf(trendChart);

      // category chart (bar or stacked if mode=stacked)
      const catCtx = catEl.getContext('2d');
      if(mode === 'stacked'){
        // compute per-category sentiment breakdown
        const categoriesList = categories;
        const pos = categoriesList.map(c => posts.filter(p => (p.category||'Other')===c && p.label==='Positive').length);
        const neut = categoriesList.map(c => posts.filter(p => (p.category||'Other')===c && p.label==='Neutral').length);
        const neg = categoriesList.map(c => posts.filter(p => (p.category||'Other')===c && p.label==='Negative').length);
        categoryChart = new Chart(catCtx, {
          type: 'bar', data: { labels: categoriesList, datasets: [
            { label: 'Positive', data: pos, backgroundColor: 'rgba(16,185,129,0.9)' },
            { label: 'Neutral', data: neut, backgroundColor: 'rgba(100,116,139,0.9)' },
            { label: 'Negative', data: neg, backgroundColor: 'rgba(239,68,68,0.9)' }
          ]}, options: { responsive:true, maintainAspectRatio: true, scales:{ x:{ stacked:true }, y:{ stacked:true, beginAtZero:true }}, plugins:{legend:{position:'bottom'}} }
        });
      } else {
        categoryChart = new Chart(catCtx, {
          type: 'bar', data: {
            labels: categories,
            datasets: [{ label:'Count', data: categoryCounts, backgroundColor: categories.map(c => ({'Movie/TV':'#8b5cf6','Book':'#ec4899','Music':'#f97316','Game':'#0ea5e9','Other':'#64748b'}[c] || '#64748b')), borderRadius:8, borderSkipped:false }]
          }, options: { responsive:true, maintainAspectRatio: true, scales:{ y:{ beginAtZero:true, ticks:{ stepSize:1 } } }, plugins:{ legend:{ display:false } } }
        });
      }

      // sentiment doughnut
      const sentCtx = sentEl.getContext('2d');
      sentimentChart = new Chart(sentCtx, {
        type: 'doughnut', data: { labels:['Positive','Neutral','Negative'], datasets:[{ data: sentCounts, backgroundColor:['#10b981','#64748b','#ef4444'], borderWidth:0 }] }, options: { responsive:true, maintainAspectRatio: true, plugins:{legend:{position:'bottom'}} }
      });

      // trend chart (only show if history present or mode=trend)
      const trendCard = safeGetEl('trendCard');
      if(mode === 'trend' || history){
        trendCard.style.display = '';
        const tctx = trendEl.getContext('2d');
        const times = history ? history.map(h=>h.ts) : posts.slice(-30).map(p=>p.timestamp || new Date().toISOString());
        const posSeries = history ? history.map(h=>h.Positive||0) : posts.slice(-30).map(p=>p.label==='Positive'?1:0);
        const neutSeries = history ? history.map(h=>h.Neutral||0) : posts.slice(-30).map(p=>p.label==='Neutral'?1:0);
        const negSeries = history ? history.map(h=>h.Negative||0) : posts.slice(-30).map(p=>p.label==='Negative'?1:0);
        trendChart = new Chart(tctx, { type:'line', data:{ labels: times.map(t=>new Date(t).toLocaleTimeString()), datasets:[ { label:'Positive', data:posSeries, tension:0.3, fill:false }, { label:'Neutral', data:neutSeries, tension:0.3, fill:false }, { label:'Negative', data:negSeries, tension:0.3, fill:false } ]}, options:{ responsive:true, maintainAspectRatio: true, plugins:{legend:{position:'bottom'}}, scales:{ y:{ beginAtZero:true } } } });
      } else {
        if(trendCard) trendCard.style.display = 'none';
      }
    }

    // --- UI update pipeline ---
    function updateUI(data, mode='default'){
      const sent = data.sentiment || {};
      safeGetEl('positiveCount').textContent = sent.Positive || 0;
      safeGetEl('neutralCount').textContent = sent.Neutral || 0;
      safeGetEl('negativeCount').textContent = sent.Negative || 0;
      renderPosts(data.posts || []);
      renderCharts(data, mode);
      const lu = safeGetEl('lastUpdate'); if(lu){ lu.textContent = 'Last fetched: ' + new Date().toLocaleString(); }
    }

    // --- Data loader ---
    async function loadData(){
      try{
        const res = await fetch(`${DATA_PATH}?_=${Date.now()}`);
        if(!res.ok) throw new Error(`Failed to load (${res.status})`);
        const data = await res.json();
        const vizMode = safeGetEl('vizSelect').value;
        updateUI(data, vizMode);
        return data;
      } catch(err){
        console.error(err);
        const posts = safeGetEl('postsContainer'); if(posts) posts.innerHTML = `<div class="error">‚ö†Ô∏è Failed to load data: ${err.message}</div>`;
        return { posts: [] };
      }
    }

    // --- Controls ---
    const vizSelect = safeGetEl('vizSelect');
    vizSelect.addEventListener('change', async () => { const data = await loadData(); updateUI(data, vizSelect.value); });
    safeGetEl('refreshBtn').addEventListener('click', () => loadData());
    safeGetEl('exportBtn').addEventListener('click', async () => { const d = await loadData(); exportCSV(d.posts || []); });

    // initial load + polling
    loadData();
    setInterval(() => loadData(), 30000);
  </script>
</body>
</html>
